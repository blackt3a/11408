## 流量控制-可靠传输与滑动窗口机制

流量控制的基本方法是由接收方控制发送方发送数据的速率，常见的方式有两种==停止-等待==协议和==滑动窗口==协议。

#### 停止-等待流量控制基本原理

:o:实现：

每发送一帧，==都==要等待对方的应答信号，==才==能发送下一帧。

如果对方不回复，发送方就==一直==等待，因此传输==效率低==。





#### 滑动窗口流量控制基本原理

:o:实现：

- 任意时刻，发送方都维持一组可以==连续发送==的帧的序号，称为==发送窗口==。

  同时，接收方也维持一组可以==连续接受==的帧的序号，称为==接受窗口==

- 只有==序号==在允许范围内的帧才能==接受/发送==。
- 发送端每收到一个==确认帧==，发送窗口就向前==滑动一个==帧的位置。如果发送窗口内的==全都没有==收到确认帧，就一直等。

:o:特性：

- ==只有==接受窗口滑动，发送窗口==才==有可能滑动
- 从概念上看，==停止-等待协议==，==后退$N$帧协议==和==选择重传协议==只在发送窗口与接受窗口==大小==上有区别。
  - 停止-等待协议：发送窗口=1，接受窗口=1
  - 后退$N$帧协议：发送窗口>1，接受窗口=1
  - 选择重传协议：发送窗口>1，接受窗口>1
- 接受窗口为`1`时，可保证帧的有序接受
- 数据链路层的滑动窗口协议，窗口大小在传输过程中是确认的(区别于传输层的滑动窗口协议，因为现有实际网络很少在数据链层采用可靠传输，通常是在运输层)



#### 可靠传输机制

数据链路层的可靠传输通常使用==确认==和==超时重传==机制完成。

:o:确认：

确认帧可以让发送方知道哪些内容被==正确接受==，为了传输效率，确认可以被==捎带==在回复帧里。

:o:超时重传：

发送数据后启动==计时器==，在一定时间内没有收到确认帧，就重新发送，直到成功为止。

:o:自动重传请求

自动重传请求(Automatic Repeat reQuest,`ARQ`)，接受方请求发送方重传来恢复出错的帧。

传统自动重传分为`3`种，==停止-等待==，==后退$N$帧==和==选择重传==。后两种是滑动窗口技术和请求重传技术的==结合==，当窗口足够大时，帧在线路上连续的流动，也称`连续ARQ`协议。由此可见，==数据链路层==中==流量控制==和===可靠传输==机制是==交织==的。



## 单帧滑动窗口与停止-等待协议

在停止-等待协议中，源站发送单个帧后==必须==等待确认，在目的站回答源站之前，==不能==发送其他数据帧，相当于发送窗口和接受窗口==皆为==`1`的滑动窗口协议。

在停止-等待协议中，可能会出现两种差错。

:x:发送帧出错：

接收端检验出错误后，会简单地将错误帧==丢弃==，此时发送方一直等不到确认帧(计时器)，就会重传数据帧。

:x:确认帧出错：

发送方收不到确认帧，就==重传==。接收方收到重复的帧会==丢弃==，并==重传==一个确认帧。因为发送窗口只有`1`，所以确认帧会用`ACK0`和`ACK1`标识。

:o:缓冲区：

为了==超时重发==和==判定重复帧==的需要，发送方和接收方都会设置一个帧==缓冲区==。

发送法在发送完数据帧后==保留==副本，在接收确认帧`ACK`后，==才==清除副本。







## 多帧等待窗口与后退$N$帧协议(GBN)

后退$N$帧式`ARQ`中，发送方==不用==等待上一帧的`ACK`，就可以发送下一帧(一直发)。

接收方==只允许==按顺序接收帧。

:x:接收方检测到失序

从上一个==正确接收==的帧后，发送方全部重新发，接收方全部重新收(之前收的全部==丢弃==)

:x:发送方没收到确认

从收到确认后的第一个帧开始，发送方全部重新发，接收方全部重新收(之前收的全部==丢弃==)



:o:累积确认：

接收方需要对每一个收到的帧进行确认，按传统方式(每收一个，确认一个)会效率低。所以可以在接收方收到多个数据帧后==只进行一次==回复(累积确认)。

`ACKn`代表对`n`号帧的==确认==，同时期望下次收到`n+1`号的数据帧。



:o:注意：

如果用`n`比特对帧进行编号，则发射窗口最多是$2^n-1$，再多会==失去作用==。

后退$N$帧协议不适用于传输质量==很差==的信道，这种情况下还==不如==停止-等待。



## 多帧滑动窗口与选择重传协议(SR)

为了进一步提高信道==利用率==，可以设法==只传输==出错的数据帧(相较于后退$N$帧)。

:o:实现

当接收方怀疑帧==出错==，就发送一个`NAK`帧，要求对`NAK`中指定的帧进行==重传==(也进行了==编号==)。



:o:补充：

发送窗口$W_t$和接收窗口$W_r$通常是==相同大小==的(大于会溢出，小于没意义)。

同时，窗口数最大==只能==是帧的序号最大值的一半，即如果适用`n`比特对帧编号，满足$W_t=W_r=2^{(n-1)}$。

==否则==，将==无法==确认数据帧是==新发的==还是==重发==的。

![img](../pictures/3.4%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E4%B8%8E%E5%8F%AF%E9%9D%A0%E4%BC%A0%E8%BE%93%E6%9C%BA%E5%88%B6.assets/v2-3165432026ffd4076a4aabad4344ccf2_720w.png)

选择重传==避免==了重复上传正确帧。

:o:补充：

- 发送周期

  ==从==开始发送数据==到==接收第一个数据帧的时间

- 信道利用率

  发送数的==有效时间===占===整个周期==的比率。

- 信道吞吐率

  $信道吞吐率=发送方的发送速率\times 信道利用率$