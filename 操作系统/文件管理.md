#文件系统的基本概念


#文件的定义
文件（File）是一硬盘为载体的存储在计算机上的信息集合。
操作系统的调度是以进程为单位，同理用户的输入输出是以==文件==为单位。
为了对文件进行划分，我们贴上标签，方便分类和索引。
同时，为了方便的对文件进行访问，修改，和保存，引出了文件系统。


文件的数据结构（粗略）（自底向上）：
- 数据项（最低级的数据组织形式）
	- 基本数据项
	- 组合数据项
- 记录（一组相关数据项的集合，描述对象在某方面的属性）
- 文件（由创建者定义，具有文件名的一组相关元素的集合）

可以粗略地将文件分为字符型和二进制型



#文件控制快和索引结点
文件属性：
- 名称：唯一
- 类型：文件格式（适用哪种文件系统）
- 创建者：
- 所有者：
- 位置：硬件设备上的文件指针
- 大小：有最大允许值
- 保护：访问控制信息
- 创建（修改）时间：用于保护或追踪。
操作系统通过==文件控制块==来维护文件元数据

#文件控制块 
文件控制块(FCB)是用来存放控制文件所需要的各种文件信息的==数据结构==。实现“==按名存取==
文件控制块（FCB）的有序集合称为==文件目录==，所以FCB也同时是为文件目录项。

FCB包含的基本信息：
- 基本信息（位置，名字，逻辑结构，物理结构）
- 存取控制信息（权限）
- 使用信息（建立，修改时间）

注意：一个文件目录==也==被视作一个文件


#索引结点 
- 文件目录通常存放在磁盘上，当文件很多时，文件目录会占用大量磁盘。
- 所以，查找过程中通常将存放目录文件的==第一个盘块==调入内存，然后查找文件，如果没有文件则继续调入下一个盘块。
- 仅当查找到相关的目录项，才从该目录项找出对应文件的物理地址（不会用到除地址外的其他信息）

所以在部分系统中，采取文件名和文件描述信息==分开存储==的方式。
文件描述信息单独形成一个中数据结构，即==索引结点==。
文件目录中的每个目录项仅由==文件名==和指向==索引结点==的指针组成。

目录项=文件名+索引结点的指针
得以节省系统开销（在加载目录表的时候不用加载那么大）


结点：
- 磁盘索引结点：
		存放在==磁盘==上的索引结点，每个文件==唯一==的磁盘索引点
	- 文件主标识符 : ==拥有==者的标识符
	- 文件类型
	- 文件存取权限
	- 文件物理地址
	- 文件长度
	- 文件链接技术
	- 文件存取时间
- 内存索引结点：
		存放在==内存==中的索引结点，当文件被打开，磁盘索引结点被复制到内存。
	==增加==了以下内容：
	- 索引结点编号：标识内存索引点
	- 状态：指示上锁或修改
	- 访问计数：访问当前文件的进程计数
	- 逻辑设备号：文件所属的文件系统的设备逻辑号
	- 链接指针：指向空闲链表或散列队列的指针。？

总之，FCB或索引结点就相当于图书馆中图书的索引号。


#文件的操作 
文件是抽象的数据类型。为了gen更好地使用文件，还需要有对文件的操作
- 创建文件：创建目录项，分配硬盘空间
- 写文件：维护一个写指针
- 读文件：一个读指针（可以与写指针同用）
- 重新定位文件：将当前文件的位置指针定位到新的==文件目录项==
- 删除文件：释放硬盘空间，删除文件目录项
- 截断文件：文件属性不变，长度置0（用于覆盖文件）

文件的打开与关闭
- 当对文件实施操作时，会先检索目录。
- 为了避免每次操作都先检索目录，在使用open后，会维护一个==打开文件表==，其中记录了包括文件物理信息的文件属性，就不用每次使用都检索目录。
- 使用close时，会删除打开表中的信息

为了实现多个进程打开同一文件这一功能。操作系统通常采用两极表：
- 系统表：
	 系统表包含==所有==进程打开的==所有==文件的==原始==文件信息。
	 除此，系统表还记录每个文件被引用的==进程数==
- 进程表：
	 表示当前进程所打开的文件，但实际上是指向系统表索引结点的==指针==


打开表==不必==包含文件名，在完成FCB硬盘上的定位后，就不用再使用文件名，可以通过==文件描述符==（文件句柄），即文件索引寻址文件。

文件表包含信息：
- 文件指针
	 系统维护的上次读写的位置，也用作文件当前的指针，这个指针对于某个进程来说是唯一的，因此必须和磁盘文件属性分开存放。？
- 文件打开计数。
- 文件磁盘位置。
- 访问权限。


#文件保护
为了防止共享时的破坏和未经批准的修改，需对文件的读，写，执行进行控制。
文件保护：
- 口令保护
- 加密防护
- 访问控制

访问类型：
- 读
- 写
- 执行
- 添加（在文件尾添加新信息，区别于写）
- 删除
- 列表清单：==展示==文件名和文件属性
此外，还有对文件的重命名，复制，编辑等控制。高级的功能是通过调用低级的系统调用（协作）实现的。当保护是在低级中完成，拥有某种访问权限意味==可能==同时拥有其他的。如，当可以复制时，代表==也==可以读。


#访问控制 
在多任务的系统中，一般是通过用户的身份进行控制。为每个文件和目录增加一个==访问控制表==（Access-Control List,ACL），以规定每个用户的访问权限。
	- 优点：可以使用复杂的访问方法
	- 缺点：长度无法预计，导致复杂的空间管理。

==所以==，采用精简的访问列表：
- 拥有者
- 组
- 其他

关于另外两种访问控制方法：
- 口令：
	 系统在建立FCB时==就==附上口令，持口令者可访问
	 - 优点：开销不多
	 - 缺点：直接存放在系统中的口令不安全
- 密码：
	 密码指用户对文件进行加密，访问时需要==密钥==，
	 - 优点：保密性强，节省存储空间
	 - 缺点：加解密需要时间


注意：
- 口令和密码都是为了防止用户文件被他人==存取或窃取==，并没有控制用户对文件的==访问==类型
- 现代操作系统多是将==访问控制列表==与精简访问（用户，组，其他）列表==组合==使用。
- 对有多级目录的文件系统，不仅需要保护单个文件，还需要保护目录子文件，而目录操作和文件操作不一样，因此需要==不同==的保护机制



#文件的逻辑结构
文件的逻辑结构是从用户视角出发看到的文件组织形式。
按逻辑结构可分为==无结构==文件和==有结构==文件。
- 无结构文件（流式文件）：
	 最简单的文件组织形式，将数据按==顺序==组织成==记录==并积累，保存。杀死相关信息项的集合，以字节为单位。由于没有结构，对记录的访问只能通过==穷举==搜索的方式，因此对大多数文件不适用，但简单。对于文本信息比较适用。
	
- 有结构文件（记录式文件）：
	- 顺序文件：
		 文件中记录一个一个顺序配列，记录通常是定长的，可采用顺序存储和链表形式存储。
		 - 串结构：
			  记录的顺序与关键字无关，通常是按==存入时间==的先后，对产结构的检索必须从头开始顺序查找，比较费时。
		- 顺序结构：
			   指文件中所有记录按关键字==顺序==排列，可以采用二分法查找，提高效率。
		
	- 索引文件：
		 对于==定长==记录文件，可以根据索引号查找到文件地址。
		 对于==不定长==记录文件，还必须知道每一条记录的==长度==（类似于段）。于是可以设置一个记录记录==指针==和==长度==的索引表，索引表可以按关键字排序。因为索引表本身是一个==定长==记录的顺序文件，所以相当于将对==变长记录顺序文件==的检索转变为对==定长记录顺序文件==的==随机==检索（可以根据名字检索）
		
     
		
		索引表：
		
		| 索引号 | 长度M | 指针ptr |
		| ------ | ----- | ------- |
		| 0      | m0    | ptrA    |
		| 1      | m1    | ptrB    |
		| ...    | ...   | ...     |
		
		
		
	- 索引顺序文件：
		 索引顺序文件是顺序文件和索引文件的==结合==，最简单的索引顺序结构只使用了一级索引。
		
		 - 实现：
	       索引顺序文件将顺序文件中所有记录记录分为若干==组==（按组存储），建立一张==索引表==，索引表递增记录每一组的第一个==文件名==和指向该文件的==指针。==
		     注意：索引表中项按==顺序==存，文件记录按==组==（每组第一个文件的名字作参考）顺序存，文件记录组内==不用==按顺序。
		 - 速度优势（假设文件记录有N条,索引顺序表只有一级索引）：
		    - 顺序文件：$\frac{N}{2}$次查找
		     - 索引顺序查找：$\frac{\sqrt{N}}{2} + \frac{\sqrt{N}}{2} = \sqrt{N}$次查找
		
		
		
		
		
		索引表：
	
	| 键   | 逻辑地址                        |
	| ---- | ------------------------------- |
	| A    | 第A组的逻辑地址（A1的逻辑地址） |
	| B    | 第B组的逻辑地址（B1的逻辑地址） |
	| .... | ...                             |
	| Z    | 第Z组的逻辑地址（Z1的逻辑地址） |
	
	文件记录表：
	
	| 文件名 | 其他属性 |
	| ------ | -------- |
	| A1     | ...      |
	| A2     | ...      |
	| ...    | ...      |
	| Z1     | ...      |
	
	
	
	
	
	- 直接文件或散列文件（Hash File）
	  通过给定记录的键值或散列函数转换的键值直接==决定==记录的物理地址，不同于顺序文件和索引文件，==没有顺序==而言
	  - 优点：速度很快
	  - 缺点：映射可能会冲突



#文件的物理结构 

文件的物理结构就是研究文件的实现，即文件数据在物理存储设备上是如何分布和组织的。

可以看作是两个问题：

文件分配方式：对磁盘非空闲快的管理

文件存储空间管理：对磁盘空闲快的管理

1. 连续分配

   连续分配要求每个文件在磁盘上占有一组==连续==的块，逻辑文件中的记录顺序存储在==相邻==的块中。支持一个目录表

   | FILE | START | LENGTH |
   | ---- | ----- | ------ |
   | A    | 0     | 2      |
   | B    | 14    | 3      |
   | C    | 19    | 6      |
   | ...  | ...   | ...    |

   连续分配支持==顺序==访问和==直接==访问。

   - 优点：
     - 简单
     - 快
   - 缺点：
     - 文件长度不==适合==动态增加
     - 为了保持==有序==性，在插入和删除时会对相邻记录做物理上的移动，改变文件长度
     - 反复增删文件后会产生==外部==碎片
     - 由于很难确定文件所需空间，因此只适合长度==固定==的文件

2. 链接分配

   ​	链接分配是一种离散分配的方式，消除了外部碎片，提高了磁盘利用率，可以动态为文件分配盘块。同时又可以分为==隐式==链接和==显式==链接

   - 隐式链接

     目录项中记录的是文件的==第一块==的指针和==最后一块==指针，每个文件都有一个==内部链表==，除了最后一个盘块外，每一个盘块都记录着指向下一个盘块的==指针==

     缺点：

     - ​	只适合==顺序==查找
     - 若查找文件的某部分，也只能从文件的第一个结点开始。
     - 若其中某==结点==丢失，则文件丢失

     改良：

     - 将盘块按簇分配，可减少查找==时间==和结点==数量==（但增加了空间碎片）
     - 减少指针所占空间比例。

     可以应用与大多数操作系统

     

   - 显式链接

     - 将磁盘中链接各物理块的指针，显式地提取出来，存放到一张表里，称为==文件分配表==（File Allocation Table,FAT）.

     - FAT不仅记录了文件块的链接关系，还标明了==空闲==的磁盘块（空闲的磁盘可以用-2或-3等统一标明）,用-1表示文件的==最后==一块
     - FAT表在系统==启动==时就会被读入==内存==，因此查找在内存中进行，不用IO,会很快。



文件目录：

| 文件名 | ...  | 起始块号 |
| ------ | ---- | -------- |
| aaa    | ...  | 2        |
| bbb    | ...  | 7        |



FAT(文件分配表)：

| 盘块号 | 下一块 |
| ------ | ------ |
| 0      | 1      |
| 1      | 5      |
| 2      | 0      |
| ...    | -2     |
| n      | -2     |



1. 索引分配

   链接分配解决了连续分配的外部碎片和文件大小管理问题，但依然存在以下问题：

   - :one:除了FAT,链接分配不能有效支持直接访问;
   - :two:FAT需要较大的内存空间，在调入时会需要调入多个盘块（但完全没必要，只需调入存储对应文件==盘块号==的盘块）

   

   

   由此，引出索引分配。

实现：
				索引分配将每个文件（以文件为单位）所有盘块号都集中放起来构成==索引表==，索引表是一个数组序列，文件的存储位置是按数组==序列==排，数组元素的==值==（不是index,是value）就是相应的==物理块号==。

优点：支持==直接==访问，且没有==外部==碎片。

​			缺点：索引块的分配，增加了存储空间的开销，另外决定索引块的==大小==，也是一个问题（太大占空间，太小存不了大文件）

优化：

- 链接方案

  将多个索引块链接起来



- 多层索引（多级索引，像多级页表）

  一个4KB大小的块，二级索引可以支持最大4GB文件。

  

- 混合索引

  将多种索引方式相结合的分配方式，==既==有直接地址，==又==有一级，二级索引分配。

采用索引分配，一般会需要==两次==访问硬盘，所以通常要将文件的索引块读入内存，提高速度。



1. 混合索引分配

   混合索引由多种分配方式共同组成，是==共同==存在的。能够全面地照顾小型，中型，大型，特大型文件。对于小文件能提高访问==速度==（直接寻址），中型文件采用==单级==索引，大型文件采用二级或==多级==索引分配.

   在UNIX的混合索引中,采用==13==个地址项i.addr(0)~i.addr(12)

   - 直接地址

     设置10个直接地址项（空位）,既i.addr(0)~i.addr(9)，每一个地址项记录一个4KB块的==地址==,最多可以存储40KB大小的文件.

   - 一次间接地址

     

     i.addr(10)采用一级索引,支持$1024 \times 4KB=4M$文件大小

   - 多次间接地址

     

     ==当==文件大于$40KB+4M$,就启用多级索引

     i.addr(11)就作为==二级==索引,同理i.addr(12)和i.addr(13)可以作为==三级==和==四级索引,所以最大可以支持$40KB+4TB$





#目录

通常,一个文件目录也被视作为一个文件.



目录的概念

FCB的有序集合称为文件目录,一个FCB就是一个文件目录项.

文件管理的基本要求::one:实现==按名==存取,:two:允许==共享==.:three:允许==不同==用户对==不同==文件采用==相同==名字.



目录结构

1. 单级目录结构

   整个文件系统就只建立==一张==目录表,每个文件占==一个==目录项.

   访问文件时,先按文件名在目录中查找到相应的FCB,检查合法性后操作.建立新文件时,需先检索所有目录项,确保没有==重名==,

   删除文件时,先释放文件空间,在清除目录项

   特点:实现了==按名存储==,但查找速度==慢==,文件不允许==重名==,不便于文件==共享==

2. 两极目录结构

   克服了单级目录的缺点.将文件目录分为==主文件目录==和==用户文件目录==两级.

   主文件目录记录用户名及相应用户文件目录的存储位置.用户文件目录记录该用户文件的FCB信息.当某用户想要访问自己的文件,只需要搜索对应的UFD,即解决了用户==重名==的问题,又在一定程度上保证了文件的==安全==.

   特点:两级目录结构提高了==检索速度==,解决了==重名==问题,实现了==访问限制==,但缺乏灵活性,不能对文件==分类==.

3. 树形目录结构

   两级目录结构推广而来,形成树形目录结构.可以明显提高目录的==检索速度==和文件系统的==性能==.有==绝对==路径和==当前==路径.树形结构能对文件方便地==分类==,层次清晰,能对文件有效地==管理和保护==.不同的子树存储不同的文件,相应赋予不同的==权限==.但是树形目录中查找一个文件需要按路径名==逐级==访问中间结点,增加了磁盘访问==次数==.

4. 无环图目录结构

   树形结构能实现文件==分类==,但不便实现文件==共享==.为此,在树形目录结构的基础上增加了一些指向==同一==结点的==有向边==.被共享的结点有一个==共享计数器==,

   有向无环图实现了==共享==,但使得文件系统的管理更加==复杂==.



目录的操作

- 搜索

- 创建文件

- 删除文件

- 创建目录

- 删除目录

  - 非空目录不能删

    删除时,==先==删除目录中的所有文件,并递归删除子目录

  - 非空目录可以删

    删除时,目录中的文件和目录可以==同时==删除

- 移动目录

- 显示目录

- 修改目录





目录实现

1. 线性列表

   实现简单,但查找费时

2. 哈希表

   查找迅速.删除与插入简单,但文件间容易==冲突==

查找时,最好将目录先调入内存.





文件共享

1. 基于索引结点的共享方式(硬链接)

   被共享的文件会有一个共享==计数==器,会对原文件有影响.

2. 利用符号链实现文件共享(软连接)

   创建一个LINK文件,实质上是一个==字符串==,指向的是被共享文件的==位置==,不会对原文件有影响







文件系统

文件系统(FIle system)的主要功能是提供==高效和便捷==的磁盘访问.

两个主要任务:

- 定义文件的用户==接口==
- 使用算法和数据结构==映射==逻辑文件系统到物理文件系统



合理的文件系统层次结构(==由低到高==):

1. IO控制

   设备驱动和中断处理程序

2. 基本文件系统

   对物理块的==读写==等操作

3. 文件组合模块

   实现逻辑块与物理块==地址转换==

4. 逻辑文件系统

   逻辑文件的保护,访问控制,管理



#文件系统布局

文件系统在磁盘中的结构

文件系统存储在磁盘上. 磁盘又可以划分为多个分区,每个分区有一个==独立==的文件系统.

文件系统的可能包含的信息:

- 启动存储在分区的操作系统方式
- 总的块数
- 空闲块的数量和位置
- 目录结构
- 各个具体的文件



关于各部分的解释:

- 主引导记录(Master Boot Record,MBR):

  位于磁盘的0号扇区,用于引导计算机. 分区表给出每个分区的起始和结束地址.第一个分区是活动分区,负责操作系统的引导,即引导块.

- 引导块

  负责==引导==操作系统,每一个分区都会准备一个引导块以备操作系统启动使用,即使该区没有想有操作系统.所以,可以在同一块磁盘上实现双系统或多系统(有多个分区即可)

- 超级块

  包含文件系统的==所有==关键信息,计算机==启动时==首次使用.超级块中的信息,包括==分区块==的数量,块的==大小==,==空闲块==数量和指针,空闲的FCB数量和FCB指针.

- 文件系统中空闲块的信息

  指示文件系统的空闲块,可以使用==位图法==和==指针链接==



文件系统在内存中的结构

内存中的文件系统通过缓存提高性能.

- 内存中的安装表(mount table):

  每个已安装文件系统分区的有关信息

- 内存中的目录结构的==缓存==:

  最近访问目录的一些信息,对于安装分区的目录,还包括一个指向==分区表==的而指针.

- 整个系统的打开文件表

  每个打开文件的FCB副本,及其他信息

- 每个进程的打开文件表

  包含指向系统打开文件表表项的指针.

在创建新的文件时,应用程序调用逻辑文件系统分配新的FCB.更新内存,然后更新硬盘.

一旦文件被创建,==就==能马上IO,不过,打开文件需先调用open()将文件名传递给逻辑文件系统.==遍历==系统的打开文件表.有相应文件则链接文件,没有则在表中创见目录项.



#外存空闲空间管理

一块硬盘可以整个用于存储,也可以分开成好几个==卷==(分区,并包含文件系统)

在卷中,存放文件数据(==文件区==)和FCB的空间(==目录区==)是分离的. 卷在提供服务前,通常需要由相应的文件程序初始化.现代操作系统,通常可以==同时==访问不同的文件格式.

1. 空闲表法

   空闲表法属于==连续==分配方式.类似于内存的==动态==分配法.建立一张==空闲表==,同样采用==首次适应==算法和==最佳适应==算法

   | 序号 | 第一个空闲盘块号 | 空闲盘块数 |
   | ---- | ---------------- | ---------- |
   | 1    | 2                | 4          |
   | 2    | 9                | 3          |
   | 3    | 15               | 5          |
   | ...  | ...              | ...        |

   也会有==合并==空闲块等操作

2. 空闲链表法

   将所有空闲盘区拉成一条空闲链

   - 空闲盘块链

     将所有空闲盘块拉成一条链.分配时,从盘首依次摘下适当数目的空闲块分配给用户

     - 优点:分配和回收都简单

     - 缺点:可能效率低,链子会很长

   - 空闲盘区链

     以盘区(即多个盘块)为单位,拉成一条链,盘与盘间除了指明下一盘块的==指针==,还应有下一盘块的==大小==.

     分配法与内存的动态分配类似,采用==首次适应==算法,也会有回收过程.

     - 优点:效率高些,空闲盘区链短.
     - 缺点:可能会有点复杂.

3. 位示图法

   每一个盘块用一个==二进制位==表示,一个$M \times N$位组成的位图,代表有$M \times N$个盘块.

   - 盘块的分配:

     - ==顺序==扫描位示图,找到一个或一组为"0"的二进制位.

     - 依据二进制位的位置,==找到==对应空闲盘块号

     - ==修改==位示图

   - 盘块的回收:
     - 依据将盘块号,==找到==对应的位示图二进制位
     - ==修改==对应的二进制位.

4. 成组链接法

   成组链接法,结合了==空闲表==和==空闲链表.==,(有分级的思想,但又不同于页表).

   - 实现: 

     - 用来存放一组空闲盘块号(空闲盘块的块号)的盘成为==组链块==,

     - ==第一个==组链块,存放$N$个顺序盘块号,前$N-1$个盘块号用于正常存信息.

     - 第$N$个(即最后一个盘块号)指向的盘块是==新的组链块==(像是递归),直到链接所有.
     - 系统只保存指向第一个组链块的指针.

   - 盘块的分配:

     - 读取组链块的==指针==, 依次分配组链块存储前$N-1$个盘块.
     - 如果不够,==更新==组链块的指针(即第$N$个,同一时刻,只会使用到==一个==组链块),再次分配
     - 递归执行

   - 盘块的回收:

     - 依次回收,依次==填充==组链块
     - 当组链块填充满==时==(差最后一个),下一个回收的空闲盘块将作为==新==的组链块,并将其指针记录到旧组链块==最后一个==盘号
     - 递归执行

     越是==重要==的信息(文件系统信息等),越要放在==靠前==的组链块



#虚拟文件系统

虚拟文件系统(VFS)为用户程序提供了文件系统操作的==统一接口==, ==屏蔽==了不同文件系统的差异和细节. 用户程序可以通过VFS提供的==统一==调用函数(open等),来操作不同文件系统的文件.==无需==考虑具体的文件系统和存储介质.

虚拟文件系统采用==面向对象==的思想,它抽象了通用的文件系统模型,定义了通用文件系统结构口,新的文件系统只要==支持并实现==这些接口,就可以正常使用

层级结构(从上到下):

- 用户空间
- VFS
- 文件系统
- 存储介质



Linux中实现VFS抽象了四种对象类型,每一种对应一个数据结构(对象),包含数据(属性)和对象方法(函数表指针):

- 超级块对象

  表示一个==已经==安装(挂载)的特定文件系统

- 索引结点对象

  表示一个特定的文件

- 目录项对象

  表示一个特定的目录项

- 文件对象

  表示一个进程相关的==已打开==文件
