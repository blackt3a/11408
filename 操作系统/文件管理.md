#文件系统的基本概念


#文件的定义
文件（File）是一硬盘为载体的存储在计算机上的信息集合。
操作系统的调度是以进程为单位，同理用户的输入输出是以==文件==为单位。
为了对文件进行划分，我们贴上标签，方便分类和索引。
同时，为了方便的对文件进行访问，修改，和保存，引出了文件系统。


文件的数据结构（粗略）（自底向上）：
- 数据项（最低级的数据组织形式）
	- 基本数据项
	- 组合数据项
- 记录（一组相关数据项的集合，描述对象在某方面的属性）
- 文件（由创建者定义，具有文件名的一组相关元素的集合）

可以粗略地将文件分为字符型和二进制型



#文件控制快和索引结点
文件属性：
- 名称：唯一
- 类型：文件格式（适用哪种文件系统）
- 创建者：
- 所有者：
- 位置：硬件设备上的文件指针
- 大小：有最大允许值
- 保护：访问控制信息
- 创建（修改）时间：用于保护或追踪。
操作系统通过==文件控制块==来维护文件元数据

#文件控制块 
文件控制块(FCB)是用来存放控制文件所需要的各种文件信息的==数据结构==。实现“==按名存取==
文件控制块（FCB）的有序集合称为==文件目录==，所以FCB也同时是为文件目录项。

FCB包含的基本信息：
- 基本信息（位置，名字，逻辑结构，物理结构）
- 存取控制信息（权限）
- 使用信息（建立，修改时间）

注意：一个文件目录==也==被视作一个文件


#索引结点 
- 文件目录通常存放在磁盘上，当文件很多时，文件目录会占用大量磁盘。
- 所以，查找过程中通常将存放目录文件的==第一个盘块==调入内存，然后查找文件，如果没有文件则继续调入下一个盘块。
- 仅当查找到相关的目录项，才从该目录项找出对应文件的物理地址（不会用到除地址外的其他信息）

所以在部分系统中，采取文件名和文件描述信息==分开存储==的方式。
文件描述信息单独形成一个中数据结构，即==索引结点==。
文件目录中的每个目录项仅由==文件名==和指向==索引结点==的指针组成。

目录项=文件名+索引结点的指针
得以节省系统开销（在加载目录表的时候不用加载那么大）


结点：
- 磁盘索引结点：
		存放在==磁盘==上的索引结点，每个文件==唯一==的磁盘索引点
	- 文件主标识符 : ==拥有==者的标识符
	- 文件类型
	- 文件存取权限
	- 文件物理地址
	- 文件长度
	- 文件链接技术
	- 文件存取时间
- 内存索引结点：
		存放在==内存==中的索引结点，当文件被打开，磁盘索引结点被复制到内存。
	==增加==了以下内容：
	- 索引结点编号：标识内存索引点
	- 状态：指示上锁或修改
	- 访问计数：访问当前文件的进程计数
	- 逻辑设备号：文件所属的文件系统的设备逻辑号
	- 链接指针：指向空闲链表或散列队列的指针。？

总之，FCB或索引结点就相当于图书馆中图书的索引号。


#文件的操作 
文件是抽象的数据类型。为了gen更好地使用文件，还需要有对文件的操作
- 创建文件：创建目录项，分配硬盘空间
- 写文件：维护一个写指针
- 读文件：一个读指针（可以与写指针同用）
- 重新定位文件：将当前文件的位置指针定位到新的==文件目录项==
- 删除文件：释放硬盘空间，删除文件目录项
- 截断文件：文件属性不变，长度置0（用于覆盖文件）

文件的打开与关闭
- 当对文件实施操作时，会先检索目录。
- 为了避免每次操作都先检索目录，在使用open后，会维护一个==打开文件表==，其中记录了包括文件物理信息的文件属性，就不用每次使用都检索目录。
- 使用close时，会删除打开表中的信息

为了实现多个进程打开同一文件这一功能。操作系统通常采用两极表：
- 系统表：
	 系统表包含==所有==进程打开的==所有==文件的==原始==文件信息。
	 除此，系统表还记录每个文件被引用的==进程数==
- 进程表：
	 表示当前进程所打开的文件，但实际上是指向系统表索引结点的==指针==


打开表==不必==包含文件名，在完成FCB硬盘上的定位后，就不用再使用文件名，可以通过==文件描述符==（文件句柄），即文件索引寻址文件。

文件表包含信息：
- 文件指针
	 系统维护的上次读写的位置，也用作文件当前的指针，这个指针对于某个进程来说是唯一的，因此必须和磁盘文件属性分开存放。？
- 文件打开计数。
- 文件磁盘位置。
- 访问权限。


#文件保护
为了防止共享时的破坏和未经批准的修改，需对文件的读，写，执行进行控制。
文件保护：
- 口令保护
- 加密防护
- 访问控制

访问类型：
- 读
- 写
- 执行
- 添加（在文件尾添加新信息，区别于写）
- 删除
- 列表清单：==展示==文件名和文件属性
此外，还有对文件的重命名，复制，编辑等控制。高级的功能是通过调用低级的系统调用（协作）实现的。当保护是在低级中完成，拥有某种访问权限意味==可能==同时拥有其他的。如，当可以复制时，代表==也==可以读。


#访问控制 
在多任务的系统中，一般是通过用户的身份进行控制。为每个文件和目录增加一个==访问控制表==（Access-Control List,ACL），以规定每个用户的访问权限。
	- 优点：可以使用复杂的访问方法
	- 缺点：长度无法预计，导致复杂的空间管理。

==所以==，采用精简的访问列表：
- 拥有者
- 组
- 其他

关于另外两种访问控制方法：
- 口令：
	 系统在建立FCB时==就==附上口令，持口令者可访问
	 - 优点：开销不多
	 - 缺点：直接存放在系统中的口令不安全
- 密码：
	 密码指用户对文件进行加密，访问时需要==密钥==，
	 - 优点：保密性强，节省存储空间
	 - 缺点：加解密需要时间


注意：
- 口令和密码都是为了防止用户文件被他人==存取或窃取==，并没有控制用户对文件的==访问==类型
- 现代操作系统多是将==访问控制列表==与精简访问（用户，组，其他）列表==组合==使用。
- 对有多级目录的文件系统，不仅需要保护单个文件，还需要保护目录子文件，而目录操作和文件操作不一样，因此需要==不同==的保护机制



#文件的逻辑结构
文件的逻辑结构是从用户视角出发看到的文件组织形式。
按逻辑结构可分为==无结构==文件和==有结构==文件。
- 无结构文件（流式文件）：
	 最简单的文件组织形式，将数据按==顺序==组织成==记录==并积累，保存。杀死相关信息项的集合，以字节为单位。由于没有结构，对记录的访问只能通过==穷举==搜索的方式，因此对大多数文件不适用，但简单。对于文本信息比较适用。
	
- 有结构文件（记录式文件）：
	- 顺序文件：
		 文件中记录一个一个顺序配列，记录通常是定长的，可采用顺序存储和链表形式存储。
		 - 串结构：
			  记录的顺序与关键字无关，通常是按==存入时间==的先后，对产结构的检索必须从头开始顺序查找，比较费时。
		- 顺序结构：
			   指文件中所有记录按关键字==顺序==排列，可以采用二分法查找，提高效率。
		
	- 索引文件：
		 对于==定长==记录文件，可以根据索引号查找到文件地址。
		 对于==不定长==记录文件，还必须知道每一条记录的==长度==（类似于段）。于是可以设置一个记录记录==指针==和==长度==的索引表，索引表可以按关键字排序。因为索引表本身是一个==定长==记录的顺序文件，所以相当于将对==变长记录顺序文件==的检索转变为对==定长记录顺序文件==的==随机==检索（可以根据名字检索）
		
     
		
		索引表：
		
		| 索引号 | 长度M | 指针ptr |
		| ------ | ----- | ------- |
		| 0      | m0    | ptrA    |
		| 1      | m1    | ptrB    |
		| ...    | ...   | ...     |
		
		
		
	- 索引顺序文件：
		 索引顺序文件是顺序文件和索引文件的==结合==，最简单的索引顺序结构只使用了一级索引。
		
		 - 实现：
	       索引顺序文件将顺序文件中所有记录记录分为若干==组==（按组存储），建立一张==索引表==，索引表递增记录每一组的第一个==文件名==和指向该文件的==指针。==
		     注意：索引表中项按==顺序==存，文件记录按==组==（每组第一个文件的名字作参考）顺序存，文件记录组内==不用==按顺序。
		 - 速度优势（假设文件记录有N条,索引顺序表只有一级索引）：
		    - 顺序文件：$\frac{N}{2}$次查找
		     - 索引顺序查找：$\frac{\sqrt{N}}{2} + \frac{\sqrt{N}}{2} = \sqrt{N}$次查找
		
		
		
		
		
		索引表：
	
	| 键   | 逻辑地址                        |
	| ---- | ------------------------------- |
	| A    | 第A组的逻辑地址（A1的逻辑地址） |
	| B    | 第B组的逻辑地址（B1的逻辑地址） |
	| .... | ...                             |
	| Z    | 第Z组的逻辑地址（Z1的逻辑地址） |
	
	文件记录表：
	
	| 文件名 | 其他属性 |
	| ------ | -------- |
	| A1     | ...      |
	| A2     | ...      |
	| ...    | ...      |
	| Z1     | ...      |
	
	
	
	
	
	- 直接文件或散列文件（Hash File）
	  通过给定记录的键值或散列函数转换的键值直接==决定==记录的物理地址，不同于顺序文件和索引文件，==没有顺序==而言
	  - 优点：速度很快
	  - 缺点：映射可能会冲突



#文件的物理结构 

文件的物理结构就是研究文件的实现，即文件数据在物理存储设备上是如何分布和组织的。

可以看作是两个问题：

文件分配方式：对磁盘非空闲快的管理

文件存储空间管理：对磁盘空闲快的管理

1. 连续分配

   连续分配要求每个文件在磁盘上占有一组==连续==的块，逻辑文件中的记录顺序存储在==相邻==的块中。支持一个目录表

   | FILE | START | LENGTH |
   | ---- | ----- | ------ |
   | A    | 0     | 2      |
   | B    | 14    | 3      |
   | C    | 19    | 6      |
   | ...  | ...   | ...    |

   连续分配支持==顺序==访问和==直接==访问。

   - 优点：
     - 简单
     - 快
   - 缺点：
     - 文件长度不==适合==动态增加
     - 为了保持==有序==性，在插入和删除时会对相邻记录做物理上的移动，改变文件长度
     - 反复增删文件后会产生==外部==碎片
     - 由于很难确定文件所需空间，因此只适合长度==固定==的文件

2. 链接分配

   ​	链接分配是一种离散分配的方式，消除了外部碎片，提高了磁盘利用率，可以动态为文件分配盘块。同时又可以分为==隐式==链接和==显式==链接

   - 隐式链接

     目录项中记录的是文件的==第一块==的指针和==最后一块==指针，每个文件都有一个==内部链表==，除了最后一个盘块外，每一个盘块都记录着指向下一个盘块的==指针==

     缺点：

     - ​	只适合==顺序==查找
     - 若查找文件的某部分，也只能从文件的第一个结点开始。
     - 若其中某==结点==丢失，则文件丢失

     改良：

     - 将盘块按簇分配，可减少查找==时间==和结点==数量==（但增加了空间碎片）
     - 减少指针所占空间比例。

     可以应用与大多数操作系统

     

   - 显式链接

     - 将磁盘中链接各物理块的指针，显式地提取出来，存放到一张表里，称为==文件分配表==（File Allocation Table,FAT）.

     - FAT不仅记录了文件块的链接关系，还标明了==空闲==的磁盘块（空闲的磁盘可以用-2或-3等统一标明）,用-1表示文件的==最后==一块
     - FAT表在系统==启动==时就会被读入==内存==，因此查找在内存中进行，不用IO,会很快。



文件目录：

| 文件名 | ...  | 起始块号 |
| ------ | ---- | -------- |
| aaa    | ...  | 2        |
| bbb    | ...  | 7        |



FAT(文件分配表)：

| 盘块号 | 下一块 |
| ------ | ------ |
| 0      | 1      |
| 1      | 5      |
| 2      | 0      |
| ...    | -2     |
| n      | -2     |



1. 索引分配

   链接分配解决了连续分配的外部碎片和文件大小管理问题，但依然存在以下问题：

   - :one:除了FAT,链接分配不能有效支持直接访问;
   - :two:FAT需要较大的内存空间，在调入时会需要调入多个盘块（但完全没必要，只需调入存储对应文件==盘块号==的盘块）

   

   

   由此，引出索引分配。

实现：
				索引分配将每个文件（以文件为单位）所有盘块号都集中放起来构成==索引表==，索引表是一个数组序列，文件的存储位置是按数组==序列==排，数组元素的==值==（不是index,是value）就是相应的==物理块号==。

优点：支持==直接==访问，且没有==外部==碎片。

​			缺点：索引块的分配，增加了存储空间的开销，另外决定索引块的==大小==，也是一个问题（太大占空间，太小存不了大文件）

优化：

- 链接方案

  将多个索引块链接起来



- 多层索引（多级索引，像多级页表）

  一个4KB大小的块，二级索引可以支持最大4GB文件。

  

- 混合索引

  将多种索引方式相结合的分配方式，==既==有直接地址，==又==有一级，二级索引分配。

采用索引分配，一般会需要==两次==访问硬盘，所以通常要将文件的索引块读入内存，提高速度。



1. 混合索引分配

   混合索引由多种分配方式共同组成，是==共同==存在的。能够全面地照顾小型，中型，大型，特大型文件。对于小文件能提高访问==速度==（直接寻址），中型文件采用==单级==索引，大型文件采用二级或==多级==索引分配.

   在UNIX的混合索引中,采用==13==个地址项i.addr(0)~i.addr(12)

   - 直接地址

     设置10个直接地址项（空位）,既i.addr(0)~i.addr(9)，每一个地址项记录一个4KB块的==地址==,最多可以存储40KB大小的文件.

   - 一次间接地址

     

     i.addr(10)采用一级索引,支持$1024 \times 4KB=4M$文件大小

   - 多次间接地址

     

     ==当==文件大于$40KB+4M$,就启用多级索引

     i.addr(11)就作为==二级==索引,同理i.addr(12)和i.addr(13)可以作为==三级==和==四级索引,所以最大可以支持$40KB+4TB$





#目录

通常,一个文件目录也被视作为一个文件.



目录的概念

FCB的有序集合称为文件目录,一个FCB



